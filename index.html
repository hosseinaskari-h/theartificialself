<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768) {
            window.location.href = "mobile_responsive.html";
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSSEIN ASKARI // LATENT ARCHIVE</title>
    <style>
        :root {
            --bg: #050505;
            --text: #a0a0a0;
            --accent: #ffffff;
            --highlight: #ff3333;
            --font: 'Courier New', Courier, monospace;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); user-select: none; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0); z-index: 10000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            color: #fff; letter-spacing: 5px; cursor: pointer;
        }

        #login-content { text-align: center; }
        .login-btn { 
            font-size: 24px; padding: 15px 30px; border: 1px solid transparent; 
            text-align: center; transition: all 0.5s; font-weight: normal; 
            color: var(--accent); opacity: 0.7; display: none; /* Hidden initially */
        }
        .login-btn:hover { border-color: var(--accent); opacity: 1; letter-spacing: 8px; }

        /* Loading Screen Styles */
        #loading-ui { display: flex; flex-direction: column; align-items: center; }
        #loading-text { font-size: 12px; letter-spacing: 3px; color: var(--accent); margin-bottom: 10px; animation: blink 1s infinite; }
        #progress-container { width: 200px; height: 2px; background: #333; position: relative; }
        #progress-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.1s linear; box-shadow: 0 0 10px var(--accent); }
        @keyframes blink { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        #interface { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: none; }
        #sidebar { width: 350px; height: 100%; background: rgba(0,0,0,0.8); border-right: 1px solid #333; padding: 40px; box-sizing: border-box; display: flex; flex-direction: column; pointer-events: all; backdrop-filter: blur(15px); z-index: 100; }
        #header { margin-bottom: 40px; border-bottom: 1px solid #fff; padding-bottom: 20px; }
        h1 { font-size: 14px; font-weight: normal; letter-spacing: 2px; margin: 0 0 5px 0; color: var(--accent); }
        .meta { font-size: 10px; opacity: 0.5; }
        .contact-btn { cursor: pointer; transition: all 0.3s; opacity: 0.8; color: var(--accent); }
        .contact-btn:hover { color: #fff; text-decoration: underline; opacity: 1; }
        #project-list { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #333 transparent; padding-right: 15px; }
        #project-list::-webkit-scrollbar { width: 2px; }
        #project-list::-webkit-scrollbar-track { background: transparent; }
        #project-list::-webkit-scrollbar-thumb { background: #333; transition: background 0.3s; }
        #project-list::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .project-item { font-size: 12px; padding: 15px 0; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; opacity: 0.6; }
        .project-item:hover, .project-item.active { opacity: 1; padding-left: 10px; color: var(--accent); border-bottom: 1px solid #fff; }
        .project-id { font-size: 9px; opacity: 0.3; margin-right: 10px; }

        #info-panel { position: absolute; bottom: 40px; right: 40px; width: 400px; text-align: right; pointer-events: none; z-index: 50; }
        #info-title { font-size: 24px; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        #info-desc { font-size: 11px; line-height: 1.6; max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s ease; font-style: italic; }
        #info-desc.visible { max-height: 200px; opacity: 1; }

        #project-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 500; justify-content: center; align-items: center;
            pointer-events: all; backdrop-filter: blur(10px);
        }
        #modal-window { width: 800px; max-width: 90%; max-height: 85vh; background: #0a0a0a; border: 1px solid #333; padding: 60px; box-sizing: border-box; overflow-y: auto; position: relative; box-shadow: 0 0 100px rgba(0,0,0,1); }
        #modal-close { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 10px; letter-spacing: 2px; color: #666; transition: color 0.3s; }
        #modal-close:hover { color: #fff; }
        #modal-body h2 { font-size: 20px; color: #fff; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 15px; }
        #modal-body p { font-size: 13px; line-height: 1.8; margin-bottom: 20px; color: #aaa; }
        #modal-body img { width: 100%; margin-bottom: 30px; border: 1px solid #222; }
        #modal-body a { color: #fff; text-decoration: underline; font-size: 12px; }
        #modal-body h1 { font-size: 18px; color: #fff; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        #thought-stream { margin-top: 20px; font-size: 9px; color: #ff3333; height: 100px; overflow: hidden; opacity: 0.7; font-style: italic; line-height: 1.4; }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 20; opacity: 0.6; }
    </style>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } } </script>
</head>
<body>
    <div class="scanlines"></div>
    <div id="project-modal"><div id="modal-window"><div id="modal-close" onclick="closeProject()">[ CLOSE_INTERFACE ]</div><div id="modal-body"></div></div></div>
    <div id="login-screen">
        <div id="login-content">
            <div id="loading-ui">
                <div id="loading-text">DOWNLOADING DATA...</div>
                <div id="progress-container"><div id="progress-bar"></div></div>
            </div>
            <div class="login-btn" id="enter-btn">ENTER</div>
        </div>
    </div>
    <script>
        // Fake loader sequence
        window.addEventListener('load', () => {
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('loading-text');
            const ui = document.getElementById('loading-ui');
            const btn = document.getElementById('enter-btn');
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    text.innerText = "COMPLETE";
                    bar.style.width = '100%';
                    setTimeout(() => {
                        ui.style.display = 'none';
                        btn.style.display = 'block';
                    }, 500);
                } else {
                    width += Math.random() * 5; // Random increments
                    if(width > 100) width = 100;
                    bar.style.width = width + '%';
                }
            }, 100);
        });
    </script>
    <div id="interface">
        <div id="sidebar">
            <div id="header">
                <h1>HOSSEIN ASKARI</h1>
                <div class="meta contact-btn" onclick="openInfo()">[ CONTACT / INFO ]</div>
            </div>
            <div id="project-list"></div>
            <div id="thought-stream">> INITIALIZING THOUGHT_STREAM...</div>
            <div class="meta" style="margin-top: 20px;">> MEMORY_ALLOC: 42%<br>> SWARM_AGENTS: 20,000<br>> RENDER_MODE: NEURAL_SYNTHESIS</div>
        </div>
        <div id="info-panel"><div id="info-title">WAITING FOR INPUT...</div><div id="info-desc"></div></div>
    </div>
    <div id="canvas-container"></div>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { GlitchPass } from 'three/addons/postprocessing/GlitchPass.js';
        import { DATA } from './projects.js';

        // --- AUDIO AGENTS ---
        let blipSynth, droneSynth, thumpSynth, shimmerSynth, spikeSynth, ghostSynth, pianoSynth, mainFilter, mainReverb;
        let isAudioInit = false;
        let heartRate = 1.0;

        // Agent 1: The Shimmer (5s Breath - Melancholy)
        const shimmerStates = ["C3", "G3", "Bb3", "Eb4", "Ab3", "F3"];
        const shimmerMatrix = {
            "C3":  [0.4, 0.2, 0.2, 0.1, 0.1, 0.0],
            "G3":  [0.2, 0.4, 0.1, 0.1, 0.1, 0.1],
            "Bb3": [0.2, 0.1, 0.5, 0.2, 0.0, 0.0], 
            "Eb4": [0.1, 0.1, 0.2, 0.5, 0.1, 0.0], 
            "Ab3": [0.1, 0.1, 0.0, 0.1, 0.5, 0.2],
            "F3":  [0.1, 0.1, 0.0, 0.0, 0.2, 0.6]
        };
        let currentShimmer = "C3";

        // Agent 2: The Ghost (7s Cycle - Reasoning)
        const ghostStates = ["F2", "Ab2", "Bb2", "C3"];
        let currentGhost = "F2";

        // Agent 3: The Spike (Probabilistic - Calculations)
        const spikeStates = ["C5", "G5", "Bb5", "D6"];

        // Agent 4: The Siegfried Piano (Soloist - Tragic/Confident)
        const siegfriedNotes = [
            { time: "0:0:0", note: "C3", dur: "2n" },
            { time: "0:2:0", note: "G2", dur: "8n" },
            { time: "0:2:2", note: "C3", dur: "8n" },
            { time: "0:3:0", note: "Eb3", dur: "2n" },
            { time: "1:1:0", note: "D3", dur: "8n" },
            { time: "1:1:2", note: "C3", dur: "8n" },
            { time: "1:2:0", note: "Bb2", dur: "8n" },
            { time: "1:2:2", note: "C3", dur: "1n" }
        ];

        function getNextState(matrix, states, current) {
            const probabilities = matrix[current] || [0.5, 0.5];
            const rand = Math.random();
            let cumulative = 0;
            for (let i = 0; i < probabilities.length; i++) {
                cumulative += probabilities[i];
                if (rand < cumulative) return states[i];
            }
            return current;
        }

        async function initAudio() {
            await Tone.start();
            mainReverb = new Tone.Reverb({ decay: 15, wet: 0.6 }).toDestination(); 
            await mainReverb.generate();
            mainFilter = new Tone.Filter(450, "lowpass").connect(mainReverb);

            droneSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "pulse" }, envelope: { attack: 5, decay: 3, sustain: 1, release: 5 } }).connect(mainFilter);
            droneSynth.volume.value = -28;

            shimmerSynth = new Tone.MonoSynth({ oscillator: { type: "sine" }, envelope: { attack: 2.5, decay: 2, sustain: 0.5, release: 2.5 } }).connect(mainFilter);
            shimmerSynth.volume.value = -24;

            ghostSynth = new Tone.AMSynth({ harmonicity: 1.5, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 4, decay: 0.1, sustain: 1, release: 4 }, modulation: { type: "triangle" } }).connect(mainFilter);
            ghostSynth.volume.value = -22;

            pianoSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 1, sustain: 0.2, release: 4 } }).connect(mainReverb);
            pianoSynth.volume.value = -14;

            spikeSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).connect(mainReverb);
            spikeSynth.volume.value = -32;

            blipSynth = new Tone.FMSynth({ harmonicity: 2, modulationIndex: 3, envelope: { attack: 0.02, decay: 0.2, sustain: 0, release: 0.4 } }).connect(mainReverb);
            blipSynth.volume.value = -18;

            thumpSynth = new Tone.MembraneSynth().connect(mainReverb);
            thumpSynth.volume.value = -12;

            // Initialize
            droneSynth.triggerAttack(["C2", "G2", "C3"], Tone.now());
            
            // NEURAL SETTLING: Smoothly lower base hum after 5s to balance the mix
            droneSynth.volume.rampTo(-38, 10, Tone.now() + 5);

            // --- POLYRHYTHMIC MARKOV LOOPS ---

            Tone.Transport.scheduleRepeat((time) => {
                currentShimmer = getNextState(shimmerMatrix, shimmerStates, currentShimmer);
                shimmerSynth.triggerAttackRelease(currentShimmer, "2n", time);
                droneSynth.set({ oscillator: { width: Math.random() * 0.1 + 0.45 } });
            }, 5);

            Tone.Transport.scheduleRepeat((time) => {
                currentGhost = ghostStates[Math.floor(Math.random() * ghostStates.length)];
                ghostSynth.triggerAttackRelease(currentGhost, "1n", time);
            }, 7);

            const siegfriedPart = new Tone.Part((time, value) => {
                pianoSynth.triggerAttackRelease(value.note, value.dur, time);
            }, siegfriedNotes).start(0);
            siegfriedPart.loop = true; siegfriedPart.loopEnd = "45s";

            Tone.Transport.scheduleRepeat((time) => {
                if (Math.random() > 0.85) {
                    const note = spikeStates[Math.floor(Math.random() * spikeStates.length)];
                    spikeSynth.triggerAttackRelease(note, "32n", time);
                }
            }, "8n"); 
            
            Tone.Transport.start();
            isAudioInit = true;
            document.getElementById('login-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);
            
            // Show Interface and Morph Particles
            document.getElementById('interface').style.display = 'flex';
            generateTarget('eye');
        }
        document.getElementById('enter-btn').addEventListener('click', initAudio);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000); camera.position.set(0, 0, 35);
        const renderer = new THREE.WebGLRenderer({ antialias: false }); renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); document.getElementById('canvas-container').appendChild(renderer.domElement);
        const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.6, 0.4, 0.85));
        const glitchPass = new GlitchPass(); glitchPass.enabled = false; composer.addPass(glitchPass);

        const particleCount = 20000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3), colors = new Float32Array(particleCount * 3);
        const targetPositions = new Float32Array(particleCount * 3), targetColors = new Float32Array(particleCount * 3), speeds = new Float32Array(particleCount);
        for(let i=0; i<particleCount; i++) {
            positions[i*3] = (Math.random()-0.5)*50; positions[i*3+1] = (Math.random()-0.5)*50; positions[i*3+2] = (Math.random()-0.5)*50;
            speeds[i] = 0.05 + Math.random()*0.05; colors[i*3] = 1; colors[i*3+1] = 1; colors[i*3+2] = 1;
            targetColors[i*3] = 1; targetColors[i*3+1] = 1; targetColors[i*3+2] = 1;
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const particles = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending }));
        scene.add(particles);

        const lineGeo = new THREE.BufferGeometry(); const linePos = new Float32Array(800 * 6);
        lineGeo.setAttribute('position', new THREE.BufferAttribute(linePos, 3));
        const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.1 });
        const synapses = new THREE.LineSegments(lineGeo, lineMat); scene.add(synapses);

        const synapseConnections = new Int32Array(800);
        function randomizeSynapses() {
            for(let i=0; i<800; i++) synapseConnections[i] = Math.floor(Math.random() * particleCount);
        }
        randomizeSynapses();

        const imgCanvas = document.createElement('canvas'); const imgCtx = imgCanvas.getContext('2d'); const imgSize = 128;
        imgCanvas.width = imgSize; imgCanvas.height = imgSize;

        function sampleImage(url) {
            const img = new Image(); img.src = url; img.crossOrigin = "Anonymous";
            img.onload = () => {
                imgCtx.drawImage(img, 0, 0, imgSize, imgSize);
                const data = imgCtx.getImageData(0, 0, imgSize, imgSize).data;
                for(let i=0; i<particleCount; i++) {
                    const pixelIndex = Math.floor(Math.random() * (imgSize * imgSize));
                    const p = pixelIndex * 4;
                    const r = data[p]/255, g = data[p+1]/255, b = data[p+2]/255;
                    targetPositions[i*3] = ((pixelIndex % imgSize) - 64) * 0.15;
                    targetPositions[i*3+1] = (64 - Math.floor(pixelIndex / imgSize)) * 0.15;
                    targetPositions[i*3+2] = ((r+g+b)/3) * 10; targetColors[i*3] = r; targetColors[i*3+1] = g; targetColors[i*3+2] = b;
                }
            };
        }

        function generateTarget(type, url) {
            activeShape = type || 'none';
            if (url) { sampleImage(url); return; }
            for(let i=0; i<particleCount; i++) {
                targetColors[i*3] = 1; targetColors[i*3+1] = 1; targetColors[i*3+2] = 1;
                if (activeShape === 'eye') {
                    const r = 6 + Math.random()*2, theta = Math.random()*Math.PI*2, phi = Math.acos(-1+(2*i)/particleCount);
                    const x = r*Math.cos(theta)*Math.sin(phi), y = r*Math.sin(theta)*Math.sin(phi), z = (r*0.3)*Math.cos(phi);
                    targetPositions[i*3] = x; targetPositions[i*3+1] = y;
                    if (Math.sqrt(x*x+y*y) < 2.5) { targetPositions[i*3+2] = z-(5+Math.random()*5); targetColors[i*3] = 1; targetColors[i*3+1] = 0; targetColors[i*3+2] = 0; }
                    else { targetPositions[i*3+2] = z; }
                } else if (activeShape === 'intro') {
                    // Entropy / Chaos state for login
                    const r = 40 * Math.random();
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI;
                    targetPositions[i*3] = r * Math.sin(phi) * Math.cos(theta);
                    targetPositions[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                    targetPositions[i*3+2] = r * Math.cos(phi);
                    targetColors[i*3] = 0.3; targetColors[i*3+1] = 0.3; targetColors[i*3+2] = 0.3; 
                } else if (activeShape === 'frame') {
                    const w = 40, h = 30;
                    if (i < particleCount * 0.5) {
                        targetPositions[i*3] = (Math.random() > 0.5 ? -w/2 : w/2) + (Math.random()-0.5)*2; targetPositions[i*3+1] = (Math.random()-0.5) * h;
                    } else {
                        targetPositions[i*3] = (Math.random()-0.5) * w; targetPositions[i*3+1] = (Math.random() > 0.5 ? -h/2 : h/2) + (Math.random()-0.5)*2;
                    }
                    targetPositions[i*3+2] = (Math.random()-0.5)*10; targetColors[i*3] = 0.2; targetColors[i*3+1] = 0.2; targetColors[i*3+2] = 0.2;
                } else {
                    const t = Math.random()*Math.PI*2, r = 10+(Math.random()-0.5);
                    targetPositions[i*3] = Math.cos(t)*r; targetPositions[i*3+1] = (Math.random()-0.5)*2; targetPositions[i*3+2] = Math.sin(t)*r;
                }
            }
        }

        const mouse = new THREE.Vector2(), mouseSpeed = new THREE.Vector2();
        let lastMouse = new THREE.Vector2(), shockwave = 0, idleTime = 0, isDreaming = false, activeShape = 'eye', time = 0;

        let typeInterval;
        function typeText(el, text) {
            if (!text) return;
            clearInterval(typeInterval); el.innerHTML = ""; let i = 0;
            typeInterval = setInterval(() => { if (i < text.length) { el.innerHTML += text.charAt(i); i++; } else clearInterval(typeInterval); }, 20);
        }

        const thoughts = ["Extracting semantic residue...", "Mapping non-anthropocentric space...", "Detecting emergent signal...", "Memory reconstruction...", "Dreaming of plastic trees..."];
        setInterval(() => {
            if (Math.random() > 0.7) { const s = document.getElementById('thought-stream'); s.innerHTML = "> " + thoughts[Math.floor(Math.random()*thoughts.length)] + "<br>" + s.innerHTML.substring(0, 200); }
            if (Math.random() > 0.9) { glitchPass.enabled = true; setTimeout(() => { glitchPass.enabled = false; }, 200); }
            idleTime++; if (idleTime > 15 && !isDreaming) { isDreaming = true; startDreaming(); }
        }, 1000);

        function startDreaming() { if(!isDreaming) return; const p = DATA[Math.floor(Math.random()*DATA.length)]; generateTarget(null, p.img); document.getElementById('info-title').innerText = "[DREAMING]: " + p.name; desc.classList.add('visible'); typeText(desc, p.dream); setTimeout(startDreaming, 6000); }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            const pos = geometry.attributes.position.array,
                col = geometry.attributes.color.array,
                lpos = synapses.geometry.attributes.position.array;
            mouseSpeed.subVectors(mouse, lastMouse);
            lastMouse.copy(mouse);
            const speed = mouseSpeed.length();
            shockwave *= 0.95;

            // Handle rotations based on state
            if (activeShape === 'eye' && !isDreaming) {
                particles.rotation.y += (mouse.x * 0.5 - particles.rotation.y) * 0.1;
                particles.rotation.x += (-mouse.y * 0.5 - particles.rotation.x) * 0.1;
            } else if (activeShape === 'frame') {
                particles.rotation.y += 0.001;
                particles.rotation.x *= 0.95;
            } else {
                particles.rotation.y += 0.002;
                particles.rotation.x *= 0.95;
            }

            for (let i = 0; i < particleCount; i++) {
                const ix = i * 3,
                    iy = i * 3 + 1,
                    iz = i * 3 + 2;
                const noiseX = Math.sin(pos[iy] * 0.1 + time) * 0.02 + (Math.sin(time + i) * 0.05);
                
                let tx = targetPositions[ix], ty = targetPositions[iy], tz = targetPositions[iz];

                // Mouse interaction effect (push particles away)
                if (speed > 0.01 && !isDreaming && activeShape !== 'frame') {
                    const dx = tx - mouse.x * 15, dy = ty - mouse.y * 15;
                    if (Math.sqrt(dx * dx + dy * dy) < 8) {
                        tx -= mouseSpeed.x * 40 * Math.random();
                        ty -= mouseSpeed.y * 40 * Math.random();
                    }
                }
                
                // Shockwave effect on click
                if (shockwave > 0.1) {
                    const dx = pos[ix], dy = pos[iy], dz = pos[iz];
                    const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
                    if (dist < 30) {
                        const f = shockwave * (1 / (dist + 1));
                        tx += dx * f * 2;
                        ty += dy * f * 2;
                        tz += dz * f * 2;
                    }
                }

                // Update particle positions
                pos[ix] += (tx - pos[ix]) * speeds[i] + noiseX;
                pos[iy] += (ty - pos[iy]) * speeds[i];
                pos[iz] += (tz - pos[iz]) * speeds[i]; // Use tz directly from targetPositions

                // Update colors
                col[ix] += (targetColors[ix] - col[ix]) * 0.05;
                col[iy] += (targetColors[iy] - col[iy]) * 0.05;
                col[iz] += (targetColors[iz] - col[iz]) * 0.05;

                // Update synapse lines
                if (i < 800) {
                    const lix = i * 6;
                    lpos[lix] = pos[ix];
                    lpos[lix + 1] = pos[iy];
                    lpos[lix + 2] = pos[iz];
                    const nix = synapseConnections[i] * 3;
                    lpos[lix + 3] = pos[nix];
                    lpos[lix + 4] = pos[nix + 1];
                    lpos[lix + 5] = pos[nix + 2];
                }
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
            synapses.geometry.attributes.position.needsUpdate = true;
            
            lineMat.opacity = (isDreaming || activeShape === 'frame' ? 0.2 : 0.05) + Math.sin(time * 2) * 0.05;
            
            camera.position.x += (mouse.x * 8 - camera.position.x) * 0.05;
            camera.position.y += (mouse.y * 8 - camera.position.y) * 0.05;
            camera.lookAt(0, 0, 0);
            
            if (isAudioInit && mainFilter) {
                mainFilter.frequency.rampTo(200 + ((mouse.x + 1) / 2) * 1200 + (speed * 500), 0.1);
            }
            
            composer.render();
        }
        generateTarget('intro'); animate();

        window.openInfo = function() {
            isDreaming = false; idleTime = 0;
            generateTarget('frame'); 
            const content = `
            <div class="legend-section">
                <div class="legend-header" style="margin-bottom: 10px; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 14px; letter-spacing: 2px;">INFO</div>
                <div class="legend-item" style="margin-bottom: 5px; font-size: 12px;"><strong>HOSSEIN ASKARI</strong></div>
                <div class="legend-item" style="margin-bottom: 5px; font-size: 12px;">COMPUTATIONAL ARTIST AND RESEARCHER</div>
                <div class="legend-item" style="margin-bottom: 5px; font-size: 12px;"><a href="mailto:Hosseinaskari.h@gmail.com" style="color: #aaa; text-decoration: none;">Hosseinaskari.h@gmail.com</a></div>
                <div class="legend-item" style="margin-top: 15px; font-size: 12px;">
                    <a href="data/pdf/cv.pdf" target="_blank" style="color: #fff; text-decoration: underline; margin-right: 15px;">[VIEW CV / RESUME]</a>
                    <a href="data/pdf/portfolio.pdf" target="_blank" style="color: #fff; text-decoration: underline;">[VIEW PORTFOLIO]</a>
                </div>
            </div>
            <div class="legend-section" style="margin-top: 40px;">
                <div class="legend-header" style="margin-bottom: 10px; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 14px; letter-spacing: 2px;">NETWORK LINKS</div>
                <div class="legend-item" style="margin-bottom: 8px; font-size: 12px;"><a href="https://www.instagram.com/francisbaken/" target="_blank" style="color: #aaa; text-decoration: none; transition: color 0.3s;">INSTAGRAM [FRANCISBAKEN]</a></div>
                <div class="legend-item" style="margin-bottom: 8px; font-size: 12px;"><a href="https://sites.gold.ac.uk/ma-mfa-computationalarts/hossein-askari/" target="_blank" style="color: #aaa; text-decoration: none; transition: color 0.3s;">GOLDSMITHS UNIVERSITY</a></div>
                <div class="legend-item" style="margin-bottom: 8px; font-size: 12px;"><a href="https://github.com/hosseinaskari-h" target="_blank" style="color: #aaa; text-decoration: none; transition: color 0.3s;">GITHUB REPOSITORY</a></div>
                <div class="legend-item" style="margin-bottom: 8px; font-size: 12px;"><a href="https://www.linkedin.com/in/hosseinaskari/" target="_blank" style="color: #aaa; text-decoration: none; transition: color 0.3s;">LINKEDIN PROFILE</a></div>
            </div>
            `;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('project-modal').style.display = 'flex';
            if(isAudioInit) blipSynth.triggerAttackRelease("C4", "8n");
        };

        window.openProject = function(item) { isDreaming = false; idleTime = 0; generateTarget('frame'); document.getElementById('modal-body').innerHTML = `<h2>${item.name}</h2>${item.full}`; document.getElementById('project-modal').style.display = 'flex'; if(isAudioInit) blipSynth.triggerAttackRelease("C4", "8n"); };
        window.closeProject = function() { generateTarget('eye'); document.getElementById('project-modal').style.display = 'none'; if(isAudioInit) blipSynth.triggerAttackRelease("G3", "8n"); };

        const list = document.getElementById('project-list'), title = document.getElementById('info-title'), desc = document.getElementById('info-desc');
        DATA.forEach(item => {
            const el = document.createElement('div'); el.className = 'project-item'; el.innerHTML = `<span class="project-id">${item.id}</span> ${item.name}`;
            el.addEventListener('mouseenter', () => { 
                if (activeShape === 'frame') return;
                isDreaming = false; idleTime = 0; 
                generateTarget(null, item.img); 
                title.innerText = item.name; 
                
                desc.classList.add('visible');
                typeText(desc, item.desc);

                document.querySelectorAll('.project-item').forEach(e => e.classList.remove('active')); el.classList.add('active');
                if(isAudioInit) blipSynth.triggerAttackRelease(800 + Math.random()*400, "32n");
            });
            el.addEventListener('click', () => { openProject(item); });
            list.appendChild(el);
        });
        document.addEventListener('mousemove', (e) => { 
            mouse.x = (e.clientX/window.innerWidth)*2-1; 
            mouse.y = -(e.clientY/window.innerHeight)*2+1; 
            idleTime = 0; 
            if(isDreaming){ isDreaming = false; generateTarget('eye'); } 
            if(activeShape === 'frame' && document.getElementById('project-modal').style.display === 'none') { generateTarget('eye'); }
        });
        document.addEventListener('mousedown', () => { 
            if(!isAudioInit) return; 
            shockwave = 15.0; 
            glitchPass.enabled = true; 
            setTimeout(()=>glitchPass.enabled=false, 200); 
            thumpSynth.triggerAttackRelease("C1", "16n"); 
            randomizeSynapses();
        });
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>